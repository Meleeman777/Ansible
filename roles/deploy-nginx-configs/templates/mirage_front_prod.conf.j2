server {
    server_name mirage.mirconnect.ru;
    listen 5100 ssl;
    keepalive_timeout 21;

    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 24h;
    underscores_in_headers on;

    ssl_certificate             "/etc/pki/nginx/p_m_proxy_ID.cer";
    ssl_certificate_key         "/etc/pki/nginx/p_m_proxy_ID.key";
    ssl_client_certificate      "/etc/pki/nginx/bundle_prod.cer";

    location ~ /\. {
        deny all; return 404;
    }

    location / {
        deny all; return 404;
    }

    location /healthcheck {
                    limit_except GET {
                            deny all;
                    }
                    default_type text/html;
                    return 200 "<!DOCTYPE html><h2>I am alive!</h2>\n";
            }

    location /attest {
                    limit_except POST {
                            deny all;
                    }
                    proxy_pass            https://mirage-prod-attestservice.{{ nginx_ec }}-nginx.idc.nspk.ru;
                    proxy_set_header      X-Real-IP $remote_addr;
                    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_hide_header     Server;
    }

    location /reattest {
                    limit_except POST {
                            deny all;
                    }
                    proxy_pass            https://mirage-prod-attestservice.{{ nginx_ec }}-nginx.idc.nspk.ru;
                    proxy_set_header      X-Real-IP $remote_addr;
                    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_hide_header     Server;
            }

    location /fetch {
                    limit_except POST {
        deny all;
                    }
                    proxy_pass            https://mirage-prod-fetchservice.{{ nginx_ec }}-nginx.idc.nspk.ru;
                    proxy_set_header      X-Real-IP $remote_addr;
                    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_hide_header     Server;
    }

    location /report {
                    limit_except POST {
                            deny all;
                    }
                    proxy_pass            https://mirage-prod-reportservice.{{ nginx_ec }}-nginx.idc.nspk.ru;
                    proxy_set_header      X-Real-IP $remote_addr;
                    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_hide_header     Server;
            }

    location /failover {
                    limit_except POST {
                            deny all;
                    }
                    proxy_pass            https://mirage-prod-failoverservice.{{ nginx_ec }}-nginx.idc.nspk.ru;
                    proxy_set_header      X-Real-IP $remote_addr;
                    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_hide_header     Server;
    }


#     location /nspkop {
#         root /apps;
#         etag on;
#         expires 30d;
#         add_header Content-Type application/json;
#     }

    location ^~/hs {
        return 200;
    }
}

