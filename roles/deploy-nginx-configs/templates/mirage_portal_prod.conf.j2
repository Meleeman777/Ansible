server {
    server_name miragelk.mirconnect.ru;
    listen 5000 ssl;
    keepalive_timeout 21;
    client_max_body_size 200m;
    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 24h;
    underscores_in_headers on;

    ssl_certificate             "/etc/pki/nginx/p_m_proxy_ID.cer";
    ssl_certificate_key         "/etc/pki/nginx/p_m_proxy_ID.key";
    ssl_client_certificate      "/etc/pki/nginx/bundle_prod.cer";
 

    location /config/properties.json {
        proxy_pass            https://mirage-prod-web.{{ nginx_ec }}-nginx.idc.nspk.ru/config/properties.json;
        sub_filter_types      application/json;
        sub_filter            'mirage-prod-web.{{ nginx_ec }}-nginx.idc.nspk.ru' 'miragelk.mirconnect.ru';
        sub_filter_once       off;
        proxy_set_header      X-Real-IP $remote_addr;
        proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_hide_header     Server;
}

    location ~ /\. {
        deny all; return 404;
    }

    location  /protection/v1 {
        proxy_pass            https://mirage-prod-protectionservice.{{ nginx_ec }}-nginx.idc.nspk.ru/protection/v1;
        limit_except POST {
        deny all;
        }
        if ($allowed_access = 0) {
            return 403;
        }
        proxy_read_timeout    900;
        proxy_connect_timeout 900;
        proxy_send_timeout    900;
        proxy_set_header      X-Real-IP $remote_addr;
        proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_hide_header     Server;
        proxy_hide_header     X-Powered-By;
        proxy_hide_header     X-AspNet-Version;
        proxy_max_temp_file_size 100m;
        client_max_body_size 100m;
    }
    location  /api/v1 {
        proxy_pass            https://mirage-prod-webappservice.{{ nginx_ec }}-nginx.idc.nspk.ru/api/v1;
        if ($allowed_access = 0) {
            return 403;
        }
        proxy_read_timeout    900;
        proxy_connect_timeout 900;
        proxy_send_timeout    900;
        proxy_set_header      X-Real-IP $remote_addr;
        proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_hide_header     Server;
        proxy_hide_header     X-Powered-By;
        proxy_hide_header     X-AspNet-Version;
        proxy_max_temp_file_size 200m;
        client_max_body_size     200m;

    }

    location  / {
        if ($allowed_access = 0) {
           return 403;
        }
        proxy_pass            https://mirage-prod-web.{{ nginx_ec }}-nginx.idc.nspk.ru;
        proxy_set_header      X-Real-IP $remote_addr;
        proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_hide_header     Server;
        proxy_hide_header     X-Powered-By;
        proxy_hide_header     X-AspNet-Version;
    }

#   location /nspkop {
#       root /apps;
#       etag on;
#       expires 30d;
#       add_header Content-Type application/json;
#   }

    location ^~/hs {
        return 200;
    }
}


